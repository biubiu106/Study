nfs方式启动自制简易文件夹形式的rootfs

什么是nfs？
(1)nfs是一种网络通讯协议，由服务器和客户端构成。
(2)nfs的作用。利用nfs协议可以做出很多直接性应用，我们这里使用nfs主要是做rootfs挂载。开发板中运行kernel做nfs客户端，主机ubuntu中搭建nfs服务器。在主机ubuntu的nfs服务器中导出我们制作的文件夹形式的rootfs目录，则在客户端中就可以去挂载这个文件夹形式的rootfs进而去启动系统。


搭建nfs服务器
1.安装nfs(虚拟机要能上网)
 sudo apt-get install nfs-kernel-server
 sudo apt-get install nfs-common
2.配置/etc/exports
 sudo vi /etc/exports
 添加：/my_rootfs/rootfs *(rw,sync,no_root_squash,no_subtree_check)
 保存并退出
 chmod 777 -R /my_rootfs/rootfs
 sudo showmount -e
 sudo exportfs -r
 sudo showmount localhost -e
 提示：
 		Export list for localhost:
		/my_rootfs/rootfs *
3.重启nfs服务
 sudo /etc/init.d/nfs-kernel-server restart 
 提示：
 	 * Stopping NFS kernel daemon                            [ OK ] 
	 * Unexporting directories for NFS kernel daemon...      [ OK ] 
	 * Exporting directories for NFS kernel daemon...        [ OK ] 
	 * Starting NFS kernel daemon                            [ OK ] 
4.将/my_rootfs/rootfs挂载到/opt
 mount -t nfs -o nolock localhost:/my_rootfs/rootfs /opt

5.完成后续卸载/opt
 umount /opt


配置内核以支持nfs作为rootfs
(1)设置nfs启动方式的bootargs，在uboot中设置如下启动参数（IP根据实际使用更改）
setenv bootargs root=/dev/nfs nfsroot=192.168.1.141:/my_rootfs/rootfs ip=192.168.1.10:192.168.1.141:192.168.1.1:255.255.255.0::eth0:off  init=/linuxrc console=ttySAC2,115200 


setenv bootcmd tftp 30008000 zImage\; bootm 30008000

(2)在menuconfig中配置支持nfs启动方式
配置网络部分，主要是使能CONFIG_IP_PNP以在2中能够看到Root file system on NFS选项
Networking support 
	Networking options 
		TCP/IP networking
				IP: kernel level autoconfiguration
					[*] IP: DHCP support
					[*] IP: BOOTP support
					
配置开启nfs服务
File systems  --->	
	Network File Systems  --->
		<*> NFS client support 
		[*] NFS client support for NFS version 3                                  
		[*] NFS client support for the NFSv3 ACL protocol extension 
		[*] NFS client support for NFS version 4 (EXPERIMENTAL) 
		[*] NFS client support for NFSv4.1 (DEVELOPER ONLY) 
		[*] Root file system on NFS  

总结
(1)nfs方式启动相当于开发板上的内核远程挂载到主机上的rootfs
(2)nfs方式启动不用制作rootfs镜像
(3)nfs方式不适合真正的产品，一般作为产品开发阶段调试使用


